# observability/alerts-week8.yaml
groups:
  - name: truckercore-slo
    rules:
      - alert: ApiLatencyP95High
        expr: histogram_quantile(0.95, sum(rate(http_server_duration_ms_bucket[5m])) by (le, route)) > 300
        for: 10m
        labels: { severity: page }
        annotations:
          summary: "API p95 > 300ms ({{ $labels.route }})"
          runbook: "https://runbooks/api-latency"

      - alert: WebhookDeliveryP95High
        expr: histogram_quantile(0.95, sum(rate(truckercore_webhook_delivery_seconds_bucket[5m])) by (le)) > 15
        for: 10m
        labels: { severity: page }
        annotations:
          summary: "Webhook delivery p95 > 15s"
          runbook: "https://runbooks/webhooks"

      - alert: OutboxOldestAgeHigh
        expr: max(truckercore_outbox_oldest_age_seconds) > 600
        for: 10m
        labels: { severity: warn }
        annotations:
          summary: "Oldest outbox event > 10 minutes"
          runbook: "https://runbooks/outbox"

      - alert: DLQItemsOld
        expr: sum(truckercore_outbox_dlq_total) > 0
        for: 20m
        labels: { severity: page }
        annotations:
          summary: "Dead-letter queue has items > 20m"
          runbook: "https://runbooks/dlq"

      - alert: ScopeViolationSpike
        expr: sum(rate(scope_violation_total[10m])) by (route, required_scope) > 10
        for: 10m
        labels: { severity: warn }
        annotations:
          summary: "Scope violations spike on {{ $labels.route }} ({{ $labels.required_scope }})"
          runbook: "https://runbooks/scope-violations"
