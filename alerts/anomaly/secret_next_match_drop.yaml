# Anomaly Alert: sudden drop in next-secret match rate (possible rotation issue)

groups:
- name: webhooks-anomaly
  rules:
  - alert: WebhookNextSecretMatchDrop
    expr: |
      (rate(webhook_secret_match_total{matched="next"}[30m]) / clamp_min(rate(webhook_secret_match_total[30m]), 1e-9))
        < (scalar(avg_over_time((rate(webhook_secret_match_total{matched="next"}[4h]) / clamp_min(rate(webhook_secret_match_total[4h]), 1e-9))[4h])) * 0.2)
    for: 30m
    labels:
      severity: warning
      env: staging
      owner: webhooks-oncall
    annotations:
      summary: "Secret 'next' match rate significantly below baseline"
      description: "May indicate clients not using rotated key; investigate rotation plan and traffic sources."
      owner_email: "webhooks-oncall@example.com"
