(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9652],{76878:function(e,t,a){Promise.resolve().then(a.bind(a,87888))},87888:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return z}});var l=a(57437),n=a(2265),r=a(10281);let s={low:"#eab308",medium:"#f97316",high:"#ef4444",critical:"#991b1b"},i={traffic_slowdown:"triangle-alert",collision:"car-crash",roadwork:"cone",debris:"ban",weather:"cloud-lightning",closure:"octagon-alert",police:"badge-check",lane_restriction:"layout-panel-top"},c=(0,r.eI)("https://dummy.supabase.co","dummy_key_here_for_build");var d=a(87748),o=a.n(d),u=a(76865),m=a(57662),h=a(68079),v=a(11239),x=a(61102),p=a(89337),g=a(89865),f=a(95468),y=a(74332);let b={"triangle-alert":u.Z,"car-crash":m.Z,cone:h.Z,"cloud-lightning":v.Z,"octagon-alert":x.Z,"badge-check":p.Z,"layout-panel-top":g.Z,ban:f.Z};function j(e){let{hazards:t,onSelect:a,onBoundsChange:r,initialCenter:c=[-98.5,39.8],initialZoom:d=4}=e,m=(0,n.useRef)(null),h=(0,n.useRef)(null);return(0,n.useEffect)(()=>{if(!m.current||h.current)return;let e=new(o()).Map({container:m.current,style:"https://demotiles.maplibre.org/style.json",center:c,zoom:d});h.current=e;let t=()=>{if(!r)return;let t=e.getBounds();t&&r([t.getWest(),t.getSouth(),t.getEast(),t.getNorth()])};return e.on("load",()=>t()),e.on("moveend",()=>t()),()=>{e.remove(),h.current=null}},[m.current]),(0,n.useEffect)(()=>{var e;let n=h.current;n&&(null===(e=n.__hazard_markers)||void 0===e||e.forEach(e=>e.remove()),n.__hazard_markers=[],t.forEach(e=>{var t;let r=document.createElement("div");r.className="flex items-center justify-center rounded-full shadow-lg",r.style.width="28px",r.style.height="28px",r.style.background=s[e.severity];let c=null!==(t=b[i[e.type]])&&void 0!==t?t:u.Z,d=y.renderToStaticMarkup((0,l.jsx)(c,{color:"white",size:18})),m=document.createElement("div");m.innerHTML=d,r.appendChild(m);let h=new(o()).Marker({element:r}).setLngLat([e.lng,e.lat]).addTo(n);h.getElement().addEventListener("click",()=>null==a?void 0:a(e)),n.__hazard_markers.push(h)}))},[JSON.stringify(t)]),(0,l.jsx)("div",{ref:m,className:"w-full h-[480px] rounded-2xl overflow-hidden ring-1 ring-black/10"})}var _=a(22135),w=a(40875),N=a(25846);function k(e){var t;return null!==(t=({critical:0,high:1,medium:2,low:3})[e])&&void 0!==t?t:3}function E(e){let{hazards:t,coachingTips:a=[]}=e,[r,i]=(0,n.useState)(null),c=(0,n.useMemo)(()=>[...t].sort((e,t)=>{let a=k(e.severity)-k(t.severity);return 0!==a?a:new Date(t.detected_at).getTime()-new Date(e.detected_at).getTime()}),[t]),d=(0,n.useMemo)(()=>{let e=new Map;return c.forEach(t=>{var a;let l=function(e){let t=Math.round(10*e.lat)/10,a=Math.round(10*e.lng)/10;return"".concat(e.type,"|").concat(t,",").concat(a)}(t),n=null!==(a=e.get(l))&&void 0!==a?a:[];n.push(t),e.set(l,n)}),Array.from(e.values()).map(e=>({rep:[...e].sort((e,t)=>{let a=k(e.severity)-k(t.severity);return 0!==a?a:new Date(t.detected_at).getTime()-new Date(e.detected_at).getTime()})[0],all:e})).sort((e,t)=>{let a=k(e.rep.severity)-k(t.rep.severity);return 0!==a?a:new Date(t.rep.detected_at).getTime()-new Date(e.rep.detected_at).getTime()})},[c]),o=(0,n.useMemo)(()=>{let e=new Map;return a.forEach(t=>e.set(t.hazard_id,t)),e},[a]);async function u(e){try{await fetch("/api/hazards/ack",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({hazard_id:e})})}catch(e){}}return(0,l.jsxs)("div",{className:"divide-y rounded-2xl border border-black/10 bg-white overflow-hidden",children:[d.map(e=>{var t,a,n,c;let{rep:d,all:m}=e,h=s[d.severity],v=r===d.id,x=null!==(n=o.get(d.id))&&void 0!==n?n:o.get(null!==(a=null===(t=m[0])||void 0===t?void 0:t.id)&&void 0!==a?a:""),p=Math.max(0,m.length-1);return(0,l.jsx)("div",{className:"p-3",children:(0,l.jsxs)("div",{className:"flex items-start gap-3",children:[(0,l.jsx)("div",{className:"mt-1 h-3 w-3 rounded-full",style:{background:h}}),(0,l.jsxs)("div",{className:"flex-1",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsxs)("div",{className:"font-medium",children:[null!==(c=d.title)&&void 0!==c?c:d.type,(0,l.jsxs)("span",{className:"text-xs opacity-60",children:[" ","\xb7 ",new Date(d.detected_at).toLocaleTimeString(),p>0?" \xb7 +".concat(p," nearby"):""]})]}),(0,l.jsx)("button",{className:"text-sm px-2 py-1 rounded hover:bg-black/5",onClick:()=>i(v?null:d.id),"aria-expanded":v,"aria-controls":"alert-panel-".concat(d.id),children:v?(0,l.jsx)(_.Z,{className:"w-4 h-4"}):(0,l.jsx)(w.Z,{className:"w-4 h-4"})})]}),(0,l.jsx)("div",{className:"text-sm opacity-80",children:d.description}),v&&(0,l.jsxs)("div",{id:"alert-panel-".concat(d.id),className:"mt-2 grid gap-2",children:[(0,l.jsxs)("div",{className:"text-xs",children:[(0,l.jsx)("span",{className:"opacity-70",children:"Location: "}),d.lat.toFixed(4),", ",d.lng.toFixed(4)]}),m.length>1&&(0,l.jsxs)("div",{className:"text-xs opacity-70",children:["Similar in vicinity:",(0,l.jsxs)("ul",{className:"list-disc ml-5 mt-1",children:[m.slice(0,5).map(e=>(0,l.jsxs)("li",{children:[e.type," \xb7 ",new Date(e.detected_at).toLocaleTimeString()]},e.id)),m.length>5&&(0,l.jsxs)("li",{children:["… ",m.length-5," more"]})]})]}),x&&(0,l.jsxs)("div",{className:"text-xs p-2 rounded flex gap-2 items-start bg-amber-50 border border-amber-200",children:[(0,l.jsx)(N.Z,{className:"w-4 h-4 text-amber-600 mt-0.5"}),(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"font-semibold mb-0.5",children:"Coaching Tip"}),(0,l.jsx)("div",{children:x.tip}),(0,l.jsxs)("div",{className:"mt-1 opacity-60",children:["Status: ",x.status]})]})]}),(0,l.jsxs)("div",{className:"flex gap-2",children:[(0,l.jsx)("button",{className:"text-xs px-2 py-1 rounded bg-neutral-100 hover:bg-neutral-200",onClick:()=>u(d.id),children:"Acknowledge"}),(0,l.jsx)("button",{className:"text-xs px-2 py-1 rounded bg-neutral-100 hover:bg-neutral-200",onClick:()=>{let e="https://www.google.com/maps/dir/?api=1&destination=".concat(d.lat,",").concat(d.lng);try{window.open(e,"_blank")}catch(e){}},children:"Navigate"})]})]})]})]})},d.id)}),0===d.length&&(0,l.jsx)("div",{className:"p-4 text-sm text-center opacity-60",children:"No active hazards."})]})}function S(e){var t,a;let{k:n}=e;if(!n)return null;let r=e=>null==e?"—":"".concat(Math.round(100*e),"%");return(0,l.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-3",children:[(0,l.jsx)(T,{label:"Alerts (today)",value:null!==(t=n.alerts_total)&&void 0!==t?t:"—"}),(0,l.jsx)(T,{label:"Active Peak",value:null!==(a=n.alerts_active_max)&&void 0!==a?a:"—"}),(0,l.jsx)(T,{label:"P95 Latency",value:n.p95_latency_ms?"".concat(n.p95_latency_ms," ms"):"—"}),(0,l.jsx)(T,{label:"Ack Rate",value:r(n.driver_ack_rate)}),(0,l.jsx)(T,{label:"System Uptime",value:r(n.system_uptime)})]})}function T(e){let{label:t,value:a}=e;return(0,l.jsxs)("div",{className:"rounded-xl border border-black/10 p-3 bg-white",children:[(0,l.jsx)("div",{className:"text-xs opacity-60",children:t}),(0,l.jsx)("div",{className:"text-xl font-semibold",children:a})]})}function z(){let[e,t]=(0,n.useState)(void 0),{hazards:a,loading:r}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},[t,a]=(0,n.useState)([]),[l,r]=(0,n.useState)(!0);return(0,n.useEffect)(()=>{let e=!0;(async()=>{let{data:t,error:l}=await c.from("hazards").select("*").in("status",["active","clearing"]);e&&(l&&console.error(l),a(null!=t?t:[]),r(!1))})();let t=c.channel("hazard_changes").on("postgres_changes",{event:"*",schema:"public",table:"hazards"},e=>{a(t=>{let a=[...t];if("INSERT"===e.eventType)return a.unshift(e.new),a.slice(0,500);if("UPDATE"===e.eventType){let t=a.findIndex(t=>t.id===e.new.id);return t>=0&&(a[t]=e.new),a}return"DELETE"===e.eventType?a.filter(t=>t.id!==e.old.id):a})}).subscribe();return()=>{c.removeChannel(t),e=!1}},[]),{hazards:(0,n.useMemo)(()=>{var a,l,n;return l=null!==(a=e.fleetId)&&void 0!==a?a:null,n=e.bbox,t.filter(e=>{let t=!e.fleet_id||!l||e.fleet_id===l,a=!n||function(e,t,a){let[l,n,r,s]=a;return e>=n&&e<=s&&t>=l&&t<=r}(e.lat,e.lng,n);return t&&a&&("active"===e.status||"clearing"===e.status)})},[t,e.fleetId,JSON.stringify(e.bbox)]),all:t,loading:l}}({fleetId:void 0,bbox:e}),s=function(e){let[t,a]=(0,n.useState)(null);return(0,n.useEffect)(()=>{(async()=>{let{data:e,error:t}=await c.from("hazard_kpis_daily").select("*").eq("day",new Date().toISOString().slice(0,10)).maybeSingle();t&&console.error(t),a(null!=e?e:null)})()},[void 0]),t}();return(0,l.jsxs)("div",{className:"p-4 grid gap-4",children:[(0,l.jsx)(S,{k:s}),(0,l.jsxs)("div",{className:"grid md:grid-cols-2 gap-4",children:[(0,l.jsx)(j,{hazards:a,onSelect:()=>{},onBoundsChange:t}),(0,l.jsx)("div",{className:"max-h-[480px] overflow-auto",children:(0,l.jsx)(E,{hazards:a})})]}),r&&(0,l.jsx)("div",{className:"text-sm opacity-60",children:"Loading realtime hazards…"})]})}}},function(e){e.O(0,[1402,5701,2971,2117,1744],function(){return e(e.s=76878)}),_N_E=e.O()}]);