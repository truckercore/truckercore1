(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5994],{252:function(e,t,r){Promise.resolve().then(r.bind(r,85236)),Promise.resolve().then(r.bind(r,13383))},85236:function(e,t,r){"use strict";r.d(t,{SafetyAnalytics:function(){return l}});var n=r(57437),a=r(2265),s=r(48852),i=r(63887);function l(){var e,t;let r=function(){let e="https://dummy.supabase.co",t="dummy_key_here_for_build";return a.useMemo(()=>e&&t?(0,i.eI)(e,t):null,[e,t])}(),l=(0,s.a)({queryKey:["analytics","safety","30d"],queryFn:async()=>{if(!r)return[];let{data:e}=await r.from("mv_safety_incidents_30d").select("*");return null!=e?e:[]}}),d=(0,s.a)({queryKey:["analytics","safety","90d"],queryFn:async()=>{if(!r)return[];let{data:e}=await r.from("mv_safety_incidents_90d_trend").select("*");return null!=e?e:[]}});return(0,n.jsxs)("div",{className:"rounded border bg-white p-3",children:[(0,n.jsx)("div",{className:"font-medium mb-2",children:"Analytics"}),(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,n.jsxs)("div",{className:"rounded border p-2",children:[(0,n.jsx)("div",{className:"font-medium mb-1",children:"Incidents by Type (30d)"}),(null===(e=l.data)||void 0===e?void 0:e.length)?(0,n.jsx)("ul",{className:"text-sm space-y-1",children:l.data.map(e=>(0,n.jsxs)("li",{className:"flex justify-between",children:[(0,n.jsx)("span",{className:"capitalize",children:(e.type||"").replace("_"," ")}),(0,n.jsx)("span",{children:e.count})]},e.type))}):(0,n.jsx)("div",{className:"text-sm text-gray-600",children:"No data"})]}),(0,n.jsxs)("div",{className:"rounded border p-2",children:[(0,n.jsx)("div",{className:"font-medium mb-1",children:"Daily incidents (90d)"}),(null===(t=d.data)||void 0===t?void 0:t.length)?(0,n.jsx)("ul",{className:"text-sm space-y-1 max-h-48 overflow-auto",children:d.data.map(e=>(0,n.jsxs)("li",{className:"flex justify-between",children:[(0,n.jsx)("span",{children:e.day}),(0,n.jsx)("span",{children:e.count})]},e.day))}):(0,n.jsx)("div",{className:"text-sm text-gray-600",children:"No data"})]})]})]})}},13383:function(e,t,r){"use strict";r.d(t,{SafetyLite:function(){return p}});var n=r(57437),a=r(2265),s=r(48852),i=r(29827),l=r(64250),d=r(63887);function o(e,t,r){var n;return{status:null!=t?t:"number"==typeof(null==e?void 0:e.status)?e.status:500,code:null==e?void 0:e.code,message:null!==(n=null==e?void 0:e.message)&&void 0!==n?n:"Unexpected error",requestId:r}}function c(e){let t="https://dummy.supabase.co",r="dummy_key_here_for_build";return t&&r?{client:(0,d.eI)(t,r,{global:{headers:{"x-request-id":e}}})}:{error:{status:500,code:"env_missing",message:"Supabase env not set",requestId:e}}}async function u(){let e=crypto.randomUUID();try{let{client:t,error:r}=c(e);if(r)return{data:null,error:r,requestId:e};let{data:n,error:a,status:s}=await t.from("safety_incidents").select("*").order("occurred_at",{ascending:!1});if(a)return{data:null,error:o(a,s,e),requestId:e};return{data:null!=n?n:[],error:null,requestId:e}}catch(t){return{data:null,error:o(t,500,e),requestId:e}}}async function y(e){let t=crypto.randomUUID();try{let{client:r,error:n}=c(t);if(n)return{data:null,error:n,requestId:t};let a={driver_id:e.driver_id,note:e.note};e.incident_id&&(a.incident_id=e.incident_id),e.assignee_id&&(a.assignee_id=e.assignee_id),e.due_date&&(a.due_date=e.due_date);let{data:s,error:i,status:l}=await r.from("safety_coaching").insert(a).select("*").single();if(i||!s)return{data:null,error:o(i,l,t),requestId:t};return{data:s,error:null,requestId:t}}catch(e){return{data:null,error:o(e,500,t),requestId:t}}}async function m(){let e=crypto.randomUUID();try{let{client:t,error:r}=c(e);if(r)return{data:null,error:r,requestId:e};let{data:n,error:a,status:s}=await t.from("safety_scores").select("*").order("updated_at",{ascending:!1});if(a)return{data:null,error:o(a,s,e),requestId:e};return{data:null!=n?n:[],error:null,requestId:e}}catch(t){return{data:null,error:o(t,500,e),requestId:e}}}async function v(e){let t=crypto.randomUUID();try{let{client:r,error:n}=c(t);if(n)return{data:null,error:n,requestId:t};let a="Driver acknowledged at ".concat(new Date().toISOString()),{data:s,error:i,status:l}=await r.from("safety_coaching").insert({incident_id:e,note:a}).select("*").single();if(i||!s)return{data:null,error:o(i,l,t),requestId:t};return{data:s,error:null,requestId:t}}catch(e){return{data:null,error:o(e,500,t),requestId:t}}}async function f(e){let t=crypto.randomUUID();try{let{client:r,error:n}=c(t);if(n)return{data:null,error:n,requestId:t};let{data:a,error:s,status:i}=await r.from("safety_incidents").update({resolved:!0,resolved_at:new Date().toISOString()}).eq("id",e).select("*").single();if(s||!a)return{data:null,error:o(s,i,t),requestId:t};return{data:a,error:null,requestId:t}}catch(e){return{data:null,error:o(e,500,t),requestId:t}}}var x=r(1089);function h(e){let{rows:t,requestId:r}=e;async function a(e){try{await fetch("/api/audit/log",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({action:"safety_export",status:"ok",target:null,requestId:r,details:e})})}catch(e){}}let s=async()=>{let e=new Blob([["id,driver_id,occurred_at,event_type,raw_type,severity,severity_bucket",...t.map(e=>{var t,r,n,a,s,i;let l=null!==(r=null!==(t=e.severity)&&void 0!==t?t:e.severity_int)&&void 0!==r?r:"",d=null!==(n=e.severity_bucket)&&void 0!==n?n:l>=4?"high":3===l?"medium":l?"low":"";return[e.id,e.driver_id,e.occurred_at,null!==(a=e.event_type)&&void 0!==a?a:"",null!==(i=null!==(s=e.raw_type)&&void 0!==s?s:e.type)&&void 0!==i?i:"",l,d].map(e=>"string"==typeof e?'"'+e.replace(/"/g,'""')+'"':e).join(",")})].join("\n")],{type:"text/csv"}),r=URL.createObjectURL(e),n=document.createElement("a");n.href=r,n.download="safety_incidents_".concat(new Date().toISOString().slice(0,10),".csv"),document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(r),a({format:"csv",count:t.length})},i=async()=>{try{let r=await fetch("/api/safety/export/pdf-gate"),n=await r.json();if(!r.ok||!(null==n?void 0:n.enabled)){var e;alert("PDF export disabled".concat((null==n?void 0:null===(e=n.error)||void 0===e?void 0:e.requestId)?" \xb7 requestId="+n.error.requestId:""));return}let s=window.open("","_blank");if(!s)return;let i=new Date().toLocaleString();s.document.write('<!doctype html><html><head><title>Safety Export</title><link rel="stylesheet" href="/styles/print.css" /></head><body>'),s.document.write("<h1>Safety Incidents</h1><div>Date: ".concat(i,"</div>")),s.document.write('<table style="width:100%; border-collapse:collapse" border="1"><thead><tr><th>ID</th><th>Driver</th><th>Occurred</th><th>Type</th><th>Severity</th></tr></thead><tbody>'),t.forEach(e=>{var t,r,n,a,i;let l=null!==(r=null!==(t=e.severity)&&void 0!==t?t:e.severity_int)&&void 0!==r?r:"",d=null!==(a=null!==(n=e.raw_type)&&void 0!==n?n:e.type)&&void 0!==a?a:"";s.document.write("<tr><td>".concat(e.id,"</td><td>").concat(e.driver_id,"</td><td>").concat(null!==(i=e.occurred_at)&&void 0!==i?i:"","</td><td>").concat(d,"</td><td>").concat(l,"</td></tr>"))}),s.document.write('</tbody></table><footer style="position:fixed;bottom:8px;left:8px;right:8px;text-align:center;opacity:0.6;font-size:12px">Confidential – TruckerCore</footer></body></html>'),s.document.close(),s.focus(),s.print(),a({format:"pdf",count:t.length})}catch(e){alert("PDF export failed".concat((null==e?void 0:e.message)?": "+e.message:""))}};return(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("button",{className:"text-xs px-2 py-1 rounded border",onClick:s,children:"Export CSV"}),(0,n.jsx)("button",{className:"text-xs px-2 py-1 rounded border",onClick:i,children:"Export PDF"})]})}function p(){var e,t;let[r,d]=a.useState([]),o=(0,s.a)({queryKey:["fleet","safety","incidents"],queryFn:()=>u().then(e=>{var t;return null!==(t=e.data)&&void 0!==t?t:[]})}),c=(0,s.a)({queryKey:["fleet","safety","scores"],queryFn:()=>m().then(e=>{var t;return null!==(t=e.data)&&void 0!==t?t:[]})}),v=(0,i.NL)(),f=(0,l.D)({mutationFn:e=>y(e).then(e=>{var t,r;if(!e.data)throw Object.assign(Error(null!==(r=null===(t=e.error)||void 0===t?void 0:t.message)&&void 0!==r?r:"Failed"),{requestId:e.requestId});return e.data}),onSuccess:()=>{v.invalidateQueries({queryKey:["fleet","safety","incidents"]})},onError:e=>{alert("Coaching failed".concat((null==e?void 0:e.message)?": "+e.message:"").concat((null==e?void 0:e.requestId)?" \xb7 requestId="+e.requestId:""))}}),x=null!==(e=o.data)&&void 0!==e?e:[],p=r.length?x.filter(e=>{var t,n;let a=(null!==(n=null!==(t=e.raw_type)&&void 0!==t?t:e.type)&&void 0!==n?n:"").toString();return r.includes(a)}):x;return(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[(0,n.jsxs)("div",{className:"rounded border bg-white p-3 md:col-span-2",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,n.jsx)("div",{className:"font-medium",children:"Safety Inbox"}),(0,n.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,n.jsx)(h,{rows:p}),(0,n.jsx)("label",{className:"text-gray-700",children:"Type"}),(0,n.jsx)("select",{multiple:!0,className:"border rounded p-1 min-w-[220px]",value:r,onChange:e=>{d(Array.from(e.target.selectedOptions).map(e=>e.value))},children:["accident","inspection","violation","near_miss","speeding","seatbelt","distracted","harsh_brake","harsh_accel","cornering","other"].map(e=>(0,n.jsx)("option",{value:e,children:e},e))}),r.length>0&&(0,n.jsx)("button",{className:"text-xs text-gray-600 underline",onClick:()=>d([]),children:"Clear"})]})]}),o.isLoading?(0,n.jsx)("div",{children:"Loading…"}):(0,n.jsx)("ul",{className:"divide-y",children:p.map(e=>{var t;return(0,n.jsx)("li",{className:"py-2 text-sm flex items-start justify-between",children:(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"flex items-center gap-2 font-medium",children:[(0,n.jsx)("span",{className:"inline-flex items-center gap-1",children:(0,n.jsx)(w,{value:null!==(t=e.raw_type)&&void 0!==t?t:e.type})}),(0,n.jsx)(N,{value:e.severity}),e.resolved?(0,n.jsx)("span",{className:"text-xs px-2 py-0.5 rounded border bg-green-50 text-green-700",children:"Resolved"}):null]}),(0,n.jsxs)("div",{className:"text-gray-600",children:["Driver: ",e.driver_id," \xb7 ",e.occurred_at?new Date(e.occurred_at).toLocaleString():""]}),(0,n.jsxs)("div",{className:"mt-1 flex gap-2",children:[(0,n.jsx)(g,{incident:e,onAssign:e=>f.mutate(e)}),(0,n.jsx)(b,{incident:e}),!e.resolved&&(0,n.jsx)(j,{incident:e})]})]})},e.id)})})]}),(0,n.jsxs)("div",{className:"rounded border bg-white p-3",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,n.jsx)("div",{className:"font-medium",children:"Rolling Driver Score"}),(0,n.jsx)(_,{})]}),c.isLoading?(0,n.jsx)("div",{children:"Loading…"}):(0,n.jsx)("ul",{className:"space-y-1 text-sm",children:(null!==(t=c.data)&&void 0!==t?t:[]).slice(0,10).map(e=>(0,n.jsxs)("li",{className:"flex justify-between",children:[(0,n.jsx)("span",{children:e.driver_id}),(0,n.jsx)("span",{className:"font-semibold",children:e.score})]},e.driver_id))})]})]})}function g(e){let{incident:t,onAssign:r}=e,[s,i]=a.useState(""),[l,d]=a.useState(""),[o,c]=a.useState("");return(0,n.jsxs)("div",{className:"flex items-end gap-2",children:[(0,n.jsx)("input",{className:"border rounded p-1 text-xs",placeholder:"Assignee",value:s,onChange:e=>i(e.target.value)}),(0,n.jsx)("input",{className:"border rounded p-1 text-xs",type:"date",value:l,onChange:e=>d(e.target.value)}),(0,n.jsx)("input",{className:"border rounded p-1 text-xs min-w-[160px]",placeholder:"Note",value:o,onChange:e=>c(e.target.value)}),(0,n.jsx)("button",{className:"text-xs px-2 py-1 rounded border",onClick:()=>r({driver_id:t.driver_id,note:o||"Coaching for incident ".concat(t.id),incident_id:t.id,assignee_id:s||void 0,due_date:l||void 0}),children:"Assign"})]})}function b(e){let{incident:t}=e,r=(0,i.NL)(),a=(0,l.D)({mutationFn:async()=>{let e=await v(t.id);if(e.error)throw Object.assign(Error(e.error.message),{requestId:e.requestId});return e.data},onMutate:async()=>{await r.cancelQueries({queryKey:["fleet","safety","incidents"]});let e=r.getQueryData(["fleet","safety","incidents"]);return r.setQueryData(["fleet","safety","incidents"],e=>(null!=e?e:[]).map(e=>e.id===t.id?{...e,acknowledged:!0}:e)),{prev:e}},onError:(e,t,n)=>{(null==n?void 0:n.prev)&&r.setQueryData(["fleet","safety","incidents"],n.prev),alert("Acknowledge failed".concat((null==e?void 0:e.message)?": "+e.message:"").concat((null==e?void 0:e.requestId)?" \xb7 requestId="+e.requestId:""))},onSettled:()=>{r.invalidateQueries({queryKey:["fleet","safety","incidents"]})}});return(0,n.jsx)("button",{className:"text-xs text-gray-700 underline",onClick:()=>a.mutate(),children:"Driver acknowledged"})}function j(e){let{incident:t}=e,r=(0,i.NL)(),a=(0,l.D)({mutationFn:async()=>{let e=await f(t.id);if(e.error)throw Object.assign(Error(e.error.message),{requestId:e.requestId});return e.data},onMutate:async()=>{await r.cancelQueries({queryKey:["fleet","safety","incidents"]});let e=r.getQueryData(["fleet","safety","incidents"]);return r.setQueryData(["fleet","safety","incidents"],e=>(null!=e?e:[]).map(e=>e.id===t.id?{...e,resolved:!0,resolved_at:new Date().toISOString()}:e)),{prev:e}},onError:(e,t,n)=>{(null==n?void 0:n.prev)&&r.setQueryData(["fleet","safety","incidents"],n.prev),alert("Resolve failed".concat((null==e?void 0:e.message)?": "+e.message:"").concat((null==e?void 0:e.requestId)?" \xb7 requestId="+e.requestId:""))},onSettled:()=>{r.invalidateQueries({queryKey:["fleet","safety","incidents"]})}});return(0,n.jsx)("button",{className:"text-xs text-green-700 underline",onClick:()=>a.mutate(),children:"Resolve"})}function _(){let e=(0,x.g)(),t=(0,i.NL)(),[r,s]=a.useState(!1);if(!(null==e?void 0:e.admin_safety_tools))return null;let l=async()=>{s(!0);try{var e,r,n;let a=await fetch("/api/safety/score-refresh",{method:"POST"}),s=await a.json();if(!a.ok)throw Object.assign(Error(null!==(n=null==s?void 0:null===(e=s.error)||void 0===e?void 0:e.message)&&void 0!==n?n:"Failed"),{requestId:null==s?void 0:null===(r=s.error)||void 0===r?void 0:r.requestId});t.invalidateQueries({queryKey:["fleet","safety","scores"]})}catch(e){alert("Refresh failed".concat((null==e?void 0:e.message)?": "+e.message:"").concat((null==e?void 0:e.requestId)?" \xb7 requestId="+e.requestId:""))}finally{s(!1)}};return(0,n.jsx)("button",{className:"text-xs px-2 py-1 rounded border",onClick:l,disabled:r,children:r?"Recomputing…":"Recompute scores"})}function w(e){let{value:t}=e,r=(null!=t?t:"other").toString();return(0,n.jsx)("span",{className:"text-xs px-2 py-0.5 rounded-full border bg-gray-50 capitalize",children:r.replace("_"," ")})}function N(e){let{value:t}=e,r="number"==typeof t?t:t?parseInt(String(t),10):void 0,a=!r||Number.isNaN(r)?"none":r>=4?"high":3===r?"medium":"low";return(0,n.jsxs)("span",{className:"text-xs px-2 py-0.5 rounded border ".concat("none"===a?"bg-gray-100 text-gray-700 border-gray-300":"high"===a?"bg-red-100 text-red-700 border-red-300":"medium"===a?"bg-yellow-100 text-yellow-700 border-yellow-300":"bg-green-100 text-green-700 border-green-300"),children:["Severity ",null!=r?r:"—"]})}},1089:function(e,t,r){"use strict";r.d(t,{FeatureFlagsProvider:function(){return i},g:function(){return l}});var n=r(57437),a=r(2265);let s=(0,a.createContext)({});function i(e){let{children:t,initialFlags:r={}}=e,[i]=(0,a.useState)(r);return(0,n.jsx)(s.Provider,{value:i,children:t})}function l(){return(0,a.useContext)(s)}}},function(e){e.O(0,[3887,9406,2971,2117,1744],function(){return e(e.s=252)}),_N_E=e.O()}]);