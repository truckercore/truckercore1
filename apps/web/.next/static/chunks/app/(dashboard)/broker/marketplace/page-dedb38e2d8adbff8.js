(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3404],{68324:function(e,t,r){Promise.resolve().then(r.bind(r,66512))},66512:function(e,t,r){"use strict";r.d(t,{OpenLoadsList:function(){return x}});var n=r(57437),l=r(2265),a=r(48852),i=r(64250),d=r(63887);function s(e,t,r){var n,l;return{status:null!=t?t:"number"==typeof(null==e?void 0:e.status)?e.status:500,code:null!==(n=null==e?void 0:e.code)&&void 0!==n?n:"unknown",message:null!==(l=null==e?void 0:e.message)&&void 0!==l?l:"Unexpected error",requestId:r}}function o(e){let t="https://dummy.supabase.co",r="dummy_key_here_for_build";return t&&r?{client:(0,d.eI)(t,r,{global:{headers:{"x-request-id":e}}})}:{error:{status:500,code:"env_missing",message:"Supabase env not set",requestId:e}}}async function u(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=crypto.randomUUID(),{status:r="open",pickupFrom:n,pickupTo:l,origin:a,destination:i,equipment:d,limit:u=50,cursor:c}=e;try{let{client:e,error:p}=o(t);if(p)return{data:null,error:p,requestId:t};let m=e.from("marketplace_loads").select("id,status,origin,destination,equipment,pickup_at,pay_usd,broker_id",{count:"exact"}).eq("status",r).order("pickup_at",{ascending:!1}).order("id",{ascending:!1});n&&(m=m.gte("pickup_at",n)),l&&(m=m.lte("pickup_at",l)),a&&(m=m.ilike("origin","%".concat(a,"%"))),i&&(m=m.ilike("destination","%".concat(i,"%"))),d&&(m=m.eq("equipment",d)),m=c?m.lt("pickup_at",c.pickup_at).limit(u):m.limit(u);let{data:v,error:f,status:g}=await m;if(f)return{data:null,error:s(f,g,t),requestId:t};let x=null!=v?v:[],y=null;if(x.length===u){let e=x[x.length-1];y={pickup_at:e.pickup_at,id:e.id}}return{data:{rows:x,nextCursor:y},error:null,requestId:t}}catch(e){return{data:null,error:s(e,500,t),requestId:t}}}async function c(e){let t=crypto.randomUUID();try{var r,n,l;let{client:a,error:i}=o(t);if(i)return{data:null,error:i,requestId:t};let{data:d,error:u,status:c}=await a.from("marketplace_loads").select("id,origin,destination,equipment").eq("id",e.loadId).single();if(u||!d)return{data:null,error:s(u,c,t),requestId:t};let{data:p,error:m,status:v}=await a.from("marketplace_offers").insert({load_id:e.loadId,carrier_id:e.carrierId,driver_id:null!==(r=e.driverId)&&void 0!==r?r:null,price:e.bidUsd,message:null!==(n=e.message)&&void 0!==n?n:null,metadata:e.idempotencyKey?{idempotencyKey:e.idempotencyKey}:null},{returning:"representation"}).select("id,load_id,carrier_id,price,created_at").single();if(m||!p)return{data:null,error:s(m,v,t),requestId:t};let f="".concat(d.origin," → ").concat(d.destination),{data:g,error:x,status:y}=await a.from("quote_events").insert({side:"carrier",lane:f,equipment:null!==(l=d.equipment)&&void 0!==l?l:null,quoted_usd:e.bidUsd,won:!1,metadata:e.idempotencyKey?{idempotencyKey:e.idempotencyKey}:null}).select("id,load_id,broker_id,type,created_at").single();if(x||!g)return{data:null,error:s(x,y,t),requestId:t};return{data:{offer:p,quote:g},error:null,requestId:t}}catch(e){return{data:null,error:s(e,500,t),requestId:t}}}async function p(e){let t=crypto.randomUUID();try{var r,n,l,a,i;let{client:d,error:u}=o(t);if(u)return{data:null,error:u,requestId:t};let{origin:c,destination:p}=e.lane,m=d.from("market_rates_daily").select("p50,p80,confidence,source,sample_size").eq("origin",c).eq("destination",p).order("service_date",{ascending:!1}).limit(1);e.equipment&&(m=m.eq("equipment",e.equipment)),e.date&&(m=m.lte("service_date",e.date));let{data:v,error:f,status:g}=await m;if(f)return{data:null,error:s(f,g,t),requestId:t};let x=null==v?void 0:v[0];return{data:{p50:null!==(r=null==x?void 0:x.p50)&&void 0!==r?r:null,p80:null!==(n=null==x?void 0:x.p80)&&void 0!==n?n:null,confidence:null!==(l=null==x?void 0:x.confidence)&&void 0!==l?l:null,source:null!==(a=null==x?void 0:x.source)&&void 0!==a?a:null,sample_size:null!==(i=null==x?void 0:x.sample_size)&&void 0!==i?i:null},error:null,requestId:t}}catch(e){return{data:null,error:s(e,500,t),requestId:t}}}async function m(e){let t=crypto.randomUUID();try{var r,n,l,a,i;let{client:d,error:u}=o(t);if(u)return{data:null,error:u,requestId:t};let{data:c,error:p,status:m}=await d.from("broker_credit").select("tier,d2p_days,bond_ok,insurance_ok,updated_at").eq("broker_id",e.brokerId).limit(1);if(p)return{data:null,error:s(p,m,t),requestId:t};let v=(null==c?void 0:c[0])||null;return{data:v?{tier:null!==(r=v.tier)&&void 0!==r?r:null,d2p_days:null!==(n=v.d2p_days)&&void 0!==n?n:null,bond_ok:null!==(l=v.bond_ok)&&void 0!==l?l:null,insurance_ok:null!==(a=v.insurance_ok)&&void 0!==a?a:null,updated_at:null!==(i=v.updated_at)&&void 0!==i?i:null}:{tier:null},error:null,requestId:t}}catch(e){return{data:null,error:s(e,500,t),requestId:t}}}function v(e){let{open:t,onClose:r,load:l,onApplyOffer:a}=e;return t&&l?(0,n.jsxs)("div",{className:"fixed inset-0 z-50",children:[(0,n.jsx)("div",{className:"absolute inset-0 bg-black/40",onClick:r}),(0,n.jsxs)("div",{className:"absolute right-0 top-0 h-full w-full max-w-lg bg-white shadow-xl p-4 overflow-y-auto",children:[(0,n.jsx)(f,{load:l}),(0,n.jsx)("div",{className:"mt-4 space-y-4",children:(0,n.jsx)(g,{load:l,onApplyOffer:a})})]})]}):null}function f(e){var t;let{load:r}=e,l=function(e){var t;let{data:r}=(0,a.a)({queryKey:["broker","credit","drawer",e],queryFn:async()=>e?(await m({brokerId:e})).data:null,enabled:!!e,staleTime:3e5});if(!e)return null;let l=function(e){if(!e)return null;let t=e.tier;if("A"===t||"B"===t||"C"===t)return t;let r=e.d2p_days,n=!0===e.bond_ok,l=!0===e.insurance_ok;return null!=r&&n&&l?r<=20&&n&&l?"A":r>=21&&r<=35&&n&&l?"B":"C":"C"}(r);if(!l)return(0,n.jsx)("span",{className:"text-xs rounded px-1 border text-gray-500",children:"No credit info"});let i="A"===l?"bg-green-100 text-green-700 border-green-300":"B"===l?"bg-yellow-100 text-yellow-700 border-yellow-300":"bg-red-100 text-red-700 border-red-300",d=r?"D2P: ".concat(null!==(t=r.d2p_days)&&void 0!==t?t:"—"," \xb7 Updated: ").concat(r.updated_at?new Date(r.updated_at).toLocaleDateString():"—"):"—";return(0,n.jsx)("span",{title:d,className:"text-xs rounded px-1 border ".concat(i),children:l})}(r.broker_id);return(0,n.jsxs)("div",{className:"flex items-start justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"text-lg font-semibold flex items-center gap-2",children:[(0,n.jsxs)("span",{children:[r.origin," → ",r.destination]}),l]}),(0,n.jsxs)("div",{className:"text-sm text-gray-600",children:[null!==(t=r.equipment)&&void 0!==t?t:"—"," \xb7 ",r.pickup_at?new Date(r.pickup_at).toLocaleString():""]})]}),(0,n.jsx)("button",{className:"text-gray-500 hover:text-black","aria-label":"Close",onClick:e=>{e.preventDefault()}})]})}function g(e){var t,r,a;let{load:i,onApplyOffer:d}=e,[s,o]=(0,l.useState)(0),[u,c]=(0,l.useState)(0),[m,v]=(0,l.useState)(null),[f,g]=(0,l.useState)(null),[x,y]=(0,l.useState)(!1);async function b(){y(!0),g(null),v(null),performance.now();try{var e,t,r,n,l,a,d;let o=await p({lane:{origin:i.origin,destination:i.destination},equipment:null!==(e=i.equipment)&&void 0!==e?e:null,date:null!==(t=i.pickup_at)&&void 0!==t?t:null});if(o.error){g("Insufficient market data".concat(o.error.message?": "+o.error.message:""));try{await fetch("/api/audit/log",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({action:"bid_assist",target:i.id,status:"error",requestId:o.requestId,details:{message:o.error.message}})})}catch(e){}}else{let e=null!==(l=null===(r=o.data)||void 0===r?void 0:r.p50)&&void 0!==l?l:null,t=null!==(a=null===(n=o.data)||void 0===n?void 0:n.p80)&&void 0!==a?a:null;if(null==e&&null==t){g("Insufficient market data for this lane");try{await fetch("/api/audit/log",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({action:"bid_assist",target:i.id,status:"error",requestId:o.requestId,details:{message:"no_data"}})})}catch(e){}}else{let r=null!==(d=null!=e?e:t)&&void 0!==d?d:0,n=r*(1+s/100+u/100),l=["Base ".concat(null!=e?"p50":"p80",": $").concat(r.toFixed(0)),s?"Deadhead adj: ".concat(s,"%"):"Deadhead adj: 0%",u?"Service window adj: ".concat(u,"%"):"Service window adj: 0%"],a=Math.round(n);v({p50:e,p80:t,suggested:a,rationale:l});try{await fetch("/api/audit/log",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({action:"bid_assist",target:i.id,status:"ok",requestId:o.requestId,details:{p50:e,p80:t,suggested:a,deadheadPct:s,servicePct:u}})})}catch(e){}}}}finally{performance.now(),y(!1)}}return(0,n.jsxs)("div",{className:"rounded border p-3",children:[(0,n.jsx)("div",{className:"font-medium mb-2",children:"Bid Assist"}),(0,n.jsxs)("div",{className:"flex flex-wrap items-end gap-2",children:[(0,n.jsxs)("label",{className:"text-sm",children:["Deadhead %",(0,n.jsx)("input",{type:"number",className:"block border rounded p-1 w-24",value:s,onChange:e=>o(Number(e.target.value||0))})]}),(0,n.jsxs)("label",{className:"text-sm",children:["Service window %",(0,n.jsx)("input",{type:"number",className:"block border rounded p-1 w-24",value:u,onChange:e=>c(Number(e.target.value||0))})]}),(0,n.jsx)("button",{className:"ml-auto px-3 py-1 rounded bg-blue-600 text-white",onClick:b,disabled:x,children:x?"Suggesting…":"Suggest Bid"})]}),f?(0,n.jsx)("div",{className:"mt-2 text-sm text-red-600",children:f}):null,m&&(0,n.jsxs)("div",{className:"mt-3 text-sm",children:[(0,n.jsxs)("div",{className:"font-semibold",children:["Suggested: $",null===(t=m.suggested)||void 0===t?void 0:t.toFixed(0)]}),(0,n.jsxs)("div",{className:"text-gray-700",children:["Band: $",null!==(r=m.p50)&&void 0!==r?r:"—"," – $",null!==(a=m.p80)&&void 0!==a?a:"—"]}),(0,n.jsx)("ul",{className:"list-disc pl-5 mt-1 text-gray-700",children:m.rationale.map((e,t)=>(0,n.jsx)("li",{children:e},t))}),(0,n.jsx)("button",{className:"mt-2 px-3 py-1 rounded border",onClick:()=>(null==m?void 0:m.suggested)!=null&&d(m.suggested),children:"Apply to Offer"})]})]})}function x(){var e;let{data:t,error:r,isLoading:d}=(0,a.a)({queryKey:["marketplace","openLoads"],queryFn:()=>u().then(e=>{var t,r;return{...e,rows:null!==(r=null===(t=e.data)||void 0===t?void 0:t.rows)&&void 0!==r?r:[]}})}),[s,o]=(0,l.useState)(!1),[p,m]=(0,l.useState)(null),f=(0,i.D)({mutationFn:async e=>{var t,r;let{amount:n}=e;if(!p)throw Error("No load selected");let l=await c({loadId:p.id,carrierId:"demo-carrier",bidUsd:n});if(l.error||!l.data)throw Object.assign(Error(null!==(r=null===(t=l.error)||void 0===t?void 0:t.message)&&void 0!==r?r:"Offer failed"),{requestId:l.requestId});return l.data},onSuccess:e=>{alert("Offer submitted successfully")},onError:e=>{alert("Offer failed".concat((null==e?void 0:e.message)?": "+e.message:"").concat((null==e?void 0:e.requestId)?" \xb7 requestId="+e.requestId:""))}});if(d)return(0,n.jsx)("div",{className:"p-4",children:"Loading loads…"});if(r)return(0,n.jsxs)("div",{className:"p-4 text-red-600",children:["Error loading: ",r.message]});let g=null!==(e=null==t?void 0:t.rows)&&void 0!==e?e:[];return g.length?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("ul",{className:"divide-y rounded border bg-white",children:g.map(e=>{var t;return(0,n.jsxs)("li",{className:"p-3 flex items-center justify-between hover:bg-gray-50 cursor-pointer",onClick:()=>{var t,r,n;m({id:e.id,origin:e.origin,destination:e.destination,equipment:null!==(t=e.equipment)&&void 0!==t?t:null,pickup_at:null!==(r=e.pickup_at)&&void 0!==r?r:null,broker_id:null!==(n=e.broker_id)&&void 0!==n?n:null}),o(!0)},children:[(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"font-medium flex items-center gap-2",children:[(0,n.jsxs)("span",{children:[e.origin," → ",e.destination]}),(0,n.jsx)(y,{brokerId:e.broker_id})]}),(0,n.jsx)("div",{className:"text-sm text-gray-500",children:null!==(t=e.equipment)&&void 0!==t?t:"—"})]}),(0,n.jsx)("div",{className:"text-sm",children:e.pickup_at?new Date(e.pickup_at).toLocaleString():""})]},e.id)})}),(0,n.jsx)(v,{open:s,onClose:()=>o(!1),load:p,onApplyOffer:e=>f.mutate({amount:e})})]}):(0,n.jsx)("div",{className:"p-4 text-gray-600",children:"No open loads"})}function y(e){var t;let{brokerId:r}=e,{data:l}=(0,a.a)({queryKey:["broker","credit",r],queryFn:async()=>r?(await m({brokerId:r})).data:null,enabled:!!r,staleTime:3e5});if(!r)return null;let i=function(e){if(!e)return null;let t=e.tier;if("A"===t||"B"===t||"C"===t)return t;let r=e.d2p_days,n=!0===e.bond_ok,l=!0===e.insurance_ok;return null!=r&&n&&l?r<=20&&n&&l?"A":r>=21&&r<=35&&n&&l?"B":"C":"C"}(l);if(!i)return(0,n.jsx)("span",{className:"text-xs rounded px-1 border text-gray-500",children:"No credit info"});let d="A"===i?"bg-green-100 text-green-700 border-green-300":"B"===i?"bg-yellow-100 text-yellow-700 border-yellow-300":"bg-red-100 text-red-700 border-red-300",s=l?"D2P: ".concat(null!==(t=l.d2p_days)&&void 0!==t?t:"—"," \xb7 Updated: ").concat(l.updated_at?new Date(l.updated_at).toLocaleDateString():"—"):"—";return(0,n.jsx)("span",{title:s,className:"text-xs rounded px-1 border ".concat(d),children:i})}}},function(e){e.O(0,[3887,9406,2971,2117,1744],function(){return e(e.s=68324)}),_N_E=e.O()}]);