"use strict";(()=>{var e={};e.id=1686,e.ids=[1686],e.modules={13688:e=>{e.exports=require("@supabase/auth-js")},52513:e=>{e.exports=require("@supabase/functions-js")},41180:e=>{e.exports=require("@supabase/node-fetch")},19168:e=>{e.exports=require("@supabase/realtime-js")},10401:e=>{e.exports=require("@supabase/storage-js")},41495:e=>{e.exports=require("ioredis")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},34818:e=>{e.exports=require("prom-client")},84770:e=>{e.exports=require("crypto")},71568:e=>{e.exports=require("zlib")},17811:e=>{e.exports=import("@supabase/postgrest-js")},9926:e=>{e.exports=import("zod")},41531:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{config:()=>c,default:()=>u,routeModule:()=>p});var n=r(71802),a=r(47153),i=r(56249),o=r(62054),l=e([o]);o=(l.then?(await l)():l)[0];let u=(0,i.l)(o,"default"),c=(0,i.l)(o,"config"),p=new n.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/exports/safety.csv",pathname:"/api/exports/safety.csv",bundlePath:"",filename:""},userland:o});s()}catch(e){s(e)}})},62054:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{default:()=>m});var n=r(84770),a=r.n(n),i=r(9926),o=r(4864),l=r(34818),u=e([i,o]);[i,o]=u.then?(await u)():u;let f=global.__metrics_registry||new l.Registry;global.__metrics_registry=f;let g=new l.Counter({name:"csv_export_requests_total",help:"CSV export requests",registers:[f]}),h=new l.Counter({name:"csv_export_errors_total",help:"CSV export errors",registers:[f]}),y=new l.Counter({name:"csv_export_rate_limited_total",help:"CSV rate-limited",registers:[f]}),v=new l.Counter({name:"csv_export_truncated_total",help:"CSV exports truncated",registers:[f]}),x=new l.Counter({name:"csv_export_sensitive_total",help:"CSV exports with sensitive columns",registers:[f]}),b=new l.Histogram({name:"csv_export_duration_seconds",help:"Duration",buckets:[.2,.5,1,2,3,5,8,13],registers:[f]}),w="https://dummy.supabase.co".replace(/\/$/,""),S=process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.SUPABASE_SERVICE_ROLE||process.env.SUPABASE_SERVICE_KEY||"";process.env.EXPORTS_BUCKET;let C=Number(process.env.CSV_ROW_CAP||2e6),q=Number(process.env.CSV_SIZE_CAP_BYTES||209715200),E="no-store",R=i.default.object({async:i.default.coerce.boolean().optional(),gzip:i.default.coerce.boolean().optional(),bom:i.default.coerce.boolean().optional(),delimiter:i.default.string().optional(),columns:i.default.string().optional(),include_sensitive:i.default.coerce.boolean().optional(),start:i.default.string().optional(),end:i.default.string().optional()});function c(){return(0,o.createClient)(w,S,{auth:{persistSession:!1}})}async function p(e,t){try{let s=(await Promise.resolve().then(r.t.bind(r,41495,23))).default,n=process.env.REDIS_URL;if(!n)throw Error("no redis");let a=new s(n,{lazyConnect:!0,maxRetriesPerRequest:1});await a.connect().catch(()=>{throw Error("connect fail")});let i=Math.floor(Date.now()/6e4),o=`rl:csv:org:${e||"anon"}:${i}`,l=`rl:csv:user:${t||"anon"}:${i}`,u=Number(process.env.RL_ORG_PER_MIN||5),c=Number(process.env.RL_USER_PER_MIN||3),[p,d]=await a.multi().incr(o).expire(o,120).incr(l).expire(l,120).exec().then(e=>[Number(e?.[0]?.[1]??0),Number(e?.[2]?.[1]??0)]);if(await a.quit().catch(()=>{}),p>u||d>c)return y.inc(),{ok:!1,retryAfter:60};return{ok:!0}}catch{let r=Math.floor(Date.now()/6e4),s=global;s.__csv_rl||={user:new Map,org:new Map};let n=`${t||"anon"}:${r}`,a=`${e||"anon"}:${r}`,i=(s.__csv_rl.user.get(n)||0)+1;s.__csv_rl.user.set(n,i);let o=(s.__csv_rl.org.get(a)||0)+1;if(s.__csv_rl.org.set(a,o),i>1||o>3)return y.inc(),{ok:!1,retryAfter:60};return{ok:!0}}}async function d(e,t,r,s,n){let a=c(),{data:i,error:o}=await a.from("export_jobs").insert({request_fingerprint:e,org_id:t,user_id:r,route:s,params:n,status:"queued",max_attempts:5}).select("id, status").single();if(o&&String(o.message).includes("duplicate key"))return(await a.from("export_jobs").select("id, status").eq("request_fingerprint",e).order("created_at",{ascending:!1}).limit(1).maybeSingle()).data||null;if(o)throw o;return i}async function _(e,t,r){let s=c().from("export_safety_view").select("*").order("created_at",{ascending:!0});e&&(s=s.eq("org_id",e)),t&&(s=s.gte("created_at",t)),r&&(s=s.lte("created_at",r));let{data:n,error:a}=await s.limit(C+1);if(a)throw a;return n||[]}async function m(e,t){let s=b.startTimer();g.inc();try{let s=e.headers["x-app-org-id"]||null,n=e.headers["x-user-id"]||null,i=await p(s,n);if(!i.ok){t.setHeader("Retry-After",String(i.retryAfter||60)),t.status(429).json({error:"rate_limited"});return}let o=R.parse({async:e.query.async,gzip:e.query.gzip,bom:e.query.bom,delimiter:e.query.delimiter,columns:e.query.columns,include_sensitive:e.query.include_sensitive,start:e.query.start,end:e.query.end}),l=o.delimiter?decodeURIComponent(o.delimiter):",",u="exports/safety.csv",c=function(e,t,r,s){let n=`${e??""}:${t??""}:${r}:${JSON.stringify(s)}`;return a().createHash("sha256").update(n).digest("hex")}(s,n,u,{...o,delimiter:l,columns:o.columns});if(o.async){let e=await d(c,s,n,u,o);t.setHeader("Cache-Control",E),t.status(202).json({job_id:e?.id,status:e?.status||"queued"});return}let m=await _(s,o.start,o.end),f=!1,g=m;m.length>C&&(g=m.slice(0,C),f=!0,v.inc()),o.include_sensitive&&x.inc();let{fields:h,mapped:y}=function(e,t){if(!t)return{fields:Object.keys(e[0]||{}),mapped:e};let r=t.split(",").map(e=>e.trim()).filter(Boolean),s=e.map(e=>{let t={};for(let s of r)t[s]=e[s];return t});return{fields:r,mapped:s}}(g,o.columns),b=[],w=new TextEncoder;o.bom&&b.push(new Uint8Array([239,187,191]));let S=h.join(l)+"\n";b.push(w.encode(S));let $=S.length+(o.bom?3:0);for(let e of y){let t=function(e,t,r){return e.map(e=>{var s;let n=t[e],a=null==n?"":String(n);return((a=(s=a)&&/^[=+\-@].*/.test(s)?`'${s}`:s).includes('"')||a.includes("\n")||a.includes("\r")||a.includes(r))&&(a=`"${a.replace(/"/g,'""')}"`),a}).join(r)+"\n"}(h,e,l),r=w.encode(t);if(($+=r.byteLength)>q){f=!0,v.inc();break}b.push(r)}let A=Buffer.concat(b),j="1"===String(o.gzip||"0");j&&(A=(await Promise.resolve().then(r.t.bind(r,71568,23))).gzipSync(A,{level:6}));let P=a().createHash("sha256").update(A).digest("hex"),H=`safety_${s||"org"}_${(o.start||"").replace(/:/g,"-")}_${(o.end||"").replace(/:/g,"-")}`.replace(/_+$/,"").replace(/[^a-zA-Z0-9._-]+/g,"_").slice(0,80)||"safety",k=j?`${H}.csv.gz`:`${H}.csv`;f&&t.setHeader("X-Partial","true"),t.setHeader("Content-Type",j?"application/gzip":"text/csv; charset=utf-8"),t.setHeader("Content-Disposition",`attachment; filename="${k}"`),t.setHeader("Cache-Control",E),t.setHeader("X-Checksum-SHA256",P),t.setHeader("X-Export-Id",c),t.setHeader("X-Row-Count",String(y.length)),t.status(200).send(A)}catch(e){h.inc(),t.status(500).json({error:"export_failed",message:e?.message||"error"})}finally{s()}}s()}catch(e){s(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[6791],()=>r(41531));module.exports=s})();