"use strict";(()=>{var e={};e.id=1964,e.ids=[1964],e.modules={13688:e=>{e.exports=require("@supabase/auth-js")},52513:e=>{e.exports=require("@supabase/functions-js")},41180:e=>{e.exports=require("@supabase/node-fetch")},19168:e=>{e.exports=require("@supabase/realtime-js")},10401:e=>{e.exports=require("@supabase/storage-js")},41495:e=>{e.exports=require("ioredis")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},34818:e=>{e.exports=require("prom-client")},17811:e=>{e.exports=import("@supabase/postgrest-js")},6005:e=>{e.exports=require("node:crypto")},47261:e=>{e.exports=require("node:util")},65628:e=>{e.exports=require("node:zlib")},83431:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{config:()=>c,default:()=>u,routeModule:()=>p});var n=r(71802),o=r(47153),i=r(56249),a=r(55613),l=e([a]);a=(l.then?(await l)():l)[0];let u=(0,i.l)(a,"default"),c=(0,i.l)(a,"config"),p=new n.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/exports/alerts.csv",pathname:"/api/exports/alerts.csv",bundlePath:"",filename:""},userland:a});s()}catch(e){s(e)}})},55613:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{default:()=>w});var n=r(6005),o=r.n(n),i=r(65628),a=r.n(i),l=r(47261),u=r(4864),c=r(41495),p=r.n(c),d=r(34818),_=e([u]);u=(_.then?(await _)():_)[0];let b=(0,l.promisify)(a().gzip),S="https://dummy.supabase.co".replace(/\/$/,""),v=process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.SUPABASE_SERVICE_ROLE||process.env.SUPABASE_SERVICE_KEY||"",E=process.env.REDIS_URL||process.env.UPSTASH_REDIS_REST_URL||"",C=process.env.REDIS_TOKEN||process.env.UPSTASH_REDIS_REST_TOKEN||"",R=global,q=R.promRegistry||new d.Registry;R.promRegistry||((0,d.collectDefaultMetrics)({register:q}),R.promRegistry=q);let A=new d.Counter({name:"csv_export_requests_total",help:"CSV export requests",labelNames:["route","org_id","status"],registers:[q]}),k=new d.Counter({name:"csv_export_errors_total",help:"CSV export errors",labelNames:["route","reason"],registers:[q]}),j=new d.Counter({name:"csv_export_rows_total",help:"CSV rows exported",labelNames:["route"],registers:[q]}),I=new d.Counter({name:"csv_export_bytes_total",help:"CSV bytes exported",labelNames:["route"],registers:[q]}),M=new d.Counter({name:"csv_export_rate_limited_total",help:"CSV export rate limited",labelNames:["route","org_id"],registers:[q]}),H=new d.Histogram({name:"csv_export_duration_seconds",help:"CSV export duration",labelNames:["route"],buckets:[.1,.25,.5,1,2,5,10],registers:[q]}),P="export-alerts.csv",$={syncMaxRows:5e4,asyncMaxRows:5e5,syncMaxBytes:10485760},D={perUserPerMin:5,perOrgPerHour:50,burstMultiplier:2};function m(e=!0){return(0,u.createClient)(S,e?v:"dummy_key_here_for_build",{auth:{persistSession:!1}})}async function g(e){return o().createHash("sha256").update(e).digest("hex")}async function f(e){try{if(!S||!v)return;let t=m(!0);await t.from("export_audit").insert({org_id:e.org_id||null,user_id:e.user_id||null,route:e.route,row_count:e.row_count,bytes:e.bytes,checksum:e.checksum,include_sensitive:e.include_sensitive,columns:e.columns||null})}catch{}}async function x(e,t){if(!E)return{ok:!0};let r=C?new(p())(E,{password:C,lazyConnect:!0}):new(p())(E,{lazyConnect:!0});try{await r.connect();let s=Math.floor(Date.now()/1e3),n=e||"unknown",o=`rl:csv:org:${n}:multiplier`,i=Number(await r.get(o)||"1")||1,a=`rl:csv:v1:${n}:${t||"anon"}:${P}:m${Math.floor(s/60)}`,l=`rl:csv:v1:${n}:__ORG__:${P}:h${Math.floor(s/3600)}`,u=D.perUserPerMin*D.burstMultiplier,c=D.perOrgPerHour*D.burstMultiplier*i,p=r.multi();p.incr(a),p.expire(a,120),p.incr(l),p.expire(l,7200);let d=await p.exec(),_=Number(d?.[0]?.[1]||0),m=Number(d?.[2]?.[1]||0);if(await r.quit(),_>u||m>c)return{ok:!1,retryAfter:60};return{ok:!0}}catch{try{await r.quit()}catch{}return{ok:!0}}}async function y(e,t=!1,r){let s=m(!0),n=s.from("v_export_alerts").select(r&&r.length?r.join(","):"*",{head:!1});if(e&&(n=n.eq("org_id",e)),!t){let t=["driver_email","driver_phone"];if(r&&0!==r.length){let o=r.filter(e=>!t.includes(e));n=s.from("v_export_alerts").select(o.join(",")),e&&(n=n.eq("org_id",e))}else n=s.from("v_export_alerts").select("* EXCEPT(driver_email,driver_phone)"),e&&(n=n.eq("org_id",e))}let{data:o,error:i}=await n.limit($.asyncMaxRows);if(i)throw i;return o||[]}async function h(e){if(!S||!v)return;let t=m(!0),{exportId:r,orgId:s,userId:n,options:o}=e;await t.from("export_jobs").insert({id:r,route:P,org_id:s||null,user_id:n||null,status:"queued",options:o,created_at:new Date().toISOString(),expires_at:new Date(Date.now()+9e5).toISOString()})}async function w(e,t){let r=H.labels(P).startTimer(),s=(0,n.randomUUID)(),{orgId:o,userId:i}=function(e){let t=e.headers["x-app-org-id"],r=e.headers["x-user-id"]||e.headers["x-supabase-uid"];return{orgId:Array.isArray(t)?t[0]:t,userId:Array.isArray(r)?r[0]:r}}(e),l=await x(o,i);if(!l.ok){M.labels(P,String(o||"unknown")).inc(),A.labels(P,String(o||"unknown"),"429").inc(),t.setHeader("Retry-After",String(l.retryAfter||60)),t.setHeader("Cache-Control","no-store"),t.status(429).json({error:"rate_limited",retry_after:l.retryAfter||60}),r();return}try{if("GET"!==e.method){t.setHeader("Allow","GET"),t.status(405).end("Method Not Allowed"),r();return}if(!S||!v){t.status(500).end("Server misconfigured"),r();return}let n=e.query,l="1"===n.include_sensitive,u="\\t"===n.delimiter||"tab"===n.delimiter?"	":"string"==typeof n.delimiter?n.delimiter:",",c="1"===n.bom,p="1"===n.gzip,d=(n.filename||"alerts").replace(/[^A-Za-z0-9._-]+/g,"_").slice(0,80),_="string"==typeof n.columns&&n.columns?n.columns.split(",").map(e=>e.trim()).filter(Boolean):void 0;l&&console.log("[export] include_sensitive=1",{orgId:o,userId:i,route:P,exportId:s});let m=await y(o,l,_),x=m.length;if(x>$.syncMaxRows){await h({exportId:s,orgId:o,userId:i,options:{bom:c,gzip:p,filename:d,includeSensitive:l,columns:_,delimiter:u}}),A.labels(P,String(o||"unknown"),"202").inc(),t.setHeader("X-Export-Id",s),t.setHeader("Cache-Control","no-store"),t.status(202).json({export_job_id:s,status:"queued"}),r();return}let w=function(e,t=",",r,s=!1){if(!e||0===e.length)return Buffer.from(s?"\uFEFF":"","utf8");let n=r&&r.length?r:Object.keys(e[0]),o=n.join(t),i=e.map(e=>n.map(r=>(function(e,t){var r;if(null==e)return"";"object"==typeof e&&(e=JSON.stringify(e));let s=String(e);return s&&(r=s,/^[=+\-@]/.test(r))&&(s="'"+s),(s.includes(t)||s.includes('"')||s.includes("\n")||s.includes("\r"))&&(s=`"${s.replace(/"/g,'""')}"`),s})(e[r],t)).join(t)).join("\n"),a=`${o}
${i}`;return Buffer.from(s?"\uFEFF"+a:a,"utf8")}(m,u,_,c),E=await g(w),C=p||w.byteLength>262144;if(C&&(w=await b(w,{level:a().constants.Z_BEST_SPEED})),w.byteLength>$.syncMaxBytes){await h({exportId:s,orgId:o,userId:i,options:{bom:c,gzip:!0,filename:d,includeSensitive:l,columns:_,delimiter:u}}),A.labels(P,String(o||"unknown"),"202").inc(),t.setHeader("X-Export-Id",s),t.setHeader("Cache-Control","no-store"),t.status(202).json({export_job_id:s,status:"queued"}),r();return}j.labels(P).inc(x),I.labels(P).inc(w.byteLength),await f({org_id:o,user_id:i,route:P,row_count:x,bytes:w.byteLength,checksum:E,include_sensitive:l,columns:_}),A.labels(P,String(o||"unknown"),"200").inc(),r();let R={"X-Export-Id":s,"X-Row-Count":String(x),"X-Checksum-SHA256":E,"Cache-Control":"no-store","Content-Disposition":`attachment; filename="${d}-${new Date().toISOString().slice(0,10).replace(/-/g,"")}.csv"`};C&&(R["Content-Encoding"]="gzip"),R["Content-Type"]="text/csv; charset=utf-8",t.writeHead(200,R),t.end(w)}catch(e){k.labels(P,e?.code||"unknown").inc(),A.labels(P,String(o||"unknown"),"500").inc(),t.setHeader("Cache-Control","no-store"),t.status(500).json({error:"export_failed"}),r()}}s()}catch(e){s(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[6791],()=>r(83431));module.exports=s})();