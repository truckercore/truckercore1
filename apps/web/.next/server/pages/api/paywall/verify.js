"use strict";(()=>{var e={};e.id=1097,e.ids=[1097],e.modules={13688:e=>{e.exports=require("@supabase/auth-js")},52513:e=>{e.exports=require("@supabase/functions-js")},41180:e=>{e.exports=require("@supabase/node-fetch")},19168:e=>{e.exports=require("@supabase/realtime-js")},10401:e=>{e.exports=require("@supabase/storage-js")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},17811:e=>{e.exports=import("@supabase/postgrest-js")},36090:e=>{e.exports=import("stripe")},91840:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{config:()=>c,default:()=>p,routeModule:()=>d});var a=s(71802),i=s(47153),n=s(56249),o=s(26927),u=e([o]);o=(u.then?(await u)():u)[0];let p=(0,n.l)(o,"default"),c=(0,n.l)(o,"config"),d=new a.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/paywall/verify",pathname:"/api/paywall/verify",bundlePath:"",filename:""},userland:o});r()}catch(e){r(e)}})},26927:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{default:()=>o});var a=s(43690),i=s(85611),n=e([a,i]);async function o(e,t){if("POST"!==e.method)return t.status(405).end();try{let{session_id:s,nonce:r,user_id:n,org_id:o}=e.body||{};if(!s||!r||!n||!o)return t.status(400).json({error:"missing"});let{data:u}=await i.p.from("paywall_nonces").select("id, used_at, expires_at").eq("user_id",n).eq("org_id",o).eq("nonce",r).maybeSingle();if(!u||u.used_at||new Date(u.expires_at)<new Date)return t.status(409).json({error:"invalid_nonce"});let p=await a.A.checkout.sessions.retrieve(s,{expand:["subscription"]});if(p.metadata?.org_id!==o||p.metadata?.user_id!==n)return t.status(403).json({error:"mismatch"});if("complete"!==p.status)return t.status(412).json({error:"not_complete"});await i.p.from("paywall_nonces").update({used_at:new Date().toISOString()}).eq("nonce",r),await i.p.from("checkout_sessions").update({status:p.status}).eq("stripe_session_id",p.id);let c=p.subscription,d=p.metadata?.tier??"premium";if(c?.status==="active"||c?.status==="trialing")return await i.p.from("billing_subscriptions").upsert({org_id:o,stripe_subscription_id:c.id,tier:d,status:c.status,current_period_end:new Date(1e3*c.current_period_end).toISOString()}),await i.p.from("profiles").update({app_tier:d,app_is_premium:!0}).eq("org_id",o),t.status(200).json({ok:!0,tier:d});return t.status(402).json({error:"subscription_not_active"})}catch(e){return t.status(500).json({error:e?.message||"server_error"})}}[a,i]=n.then?(await n)():n,r()}catch(e){r(e)}})},43690:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.d(t,{A:()=>n});var a=s(36090),i=e([a]);let n=new(a=(i.then?(await i)():i)[0]).default(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-06-20"});r()}catch(e){r(e)}})},85611:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.d(t,{p:()=>n});var a=s(4864),i=e([a]);a=(i.then?(await i)():i)[0];let n=(0,a.createClient)(process.env.SUPABASE_URL||"https://dummy.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.SUPABASE_SERVICE_ROLE||process.env.SUPABASE_SERVICE_KEY,{auth:{persistSession:!1}});r()}catch(e){r(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[6791],()=>s(91840));module.exports=r})();