"use strict";(()=>{var e={};e.id=1724,e.ids=[1724],e.modules={13688:e=>{e.exports=require("@supabase/auth-js")},52513:e=>{e.exports=require("@supabase/functions-js")},41180:e=>{e.exports=require("@supabase/node-fetch")},19168:e=>{e.exports=require("@supabase/realtime-js")},10401:e=>{e.exports=require("@supabase/storage-js")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},17811:e=>{e.exports=import("@supabase/postgrest-js")},36090:e=>{e.exports=import("stripe")},28656:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{config:()=>c,default:()=>u,routeModule:()=>d});var a=s(71802),i=s(47153),n=s(56249),o=s(26578),p=e([o]);o=(p.then?(await p)():p)[0];let u=(0,n.l)(o,"default"),c=(0,n.l)(o,"config"),d=new a.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/billing/webhook",pathname:"/api/billing/webhook",bundlePath:"",filename:""},userland:o});r()}catch(e){r(e)}})},26578:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{config:()=>u,default:()=>p});var a=s(43690),i=s(85611),n=e([a,i]);[a,i]=n.then?(await n)():n;let u={api:{bodyParser:!1}};async function o(e){let t=[];for await(let s of e)t.push(Buffer.from(s));return Buffer.concat(t)}async function p(e,t){let s;let r=e.headers["stripe-signature"];if(!r)return t.status(400).send("Missing signature");let n=await o(e);try{s=a.A.webhooks.constructEvent(n,r,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){return t.status(400).send(`Bad sig: ${e.message}`)}try{if("checkout.session.completed"===s.type){let e=s.data.object,t=e.metadata?.org_id;e.metadata?.user_id;let r=e.metadata?.tier??"premium",n=e.subscription;if(t&&n){let e=await a.A.subscriptions.retrieve(n);await i.p.from("billing_subscriptions").upsert({org_id:t,stripe_subscription_id:e.id,tier:r,status:e.status,current_period_end:new Date(1e3*e.current_period_end).toISOString()}),await i.p.from("profiles").update({app_tier:r,app_is_premium:!0}).eq("org_id",t)}}if("customer.subscription.updated"===s.type||"customer.subscription.deleted"===s.type){let e=s.data.object,t=e.metadata?.org_id;t&&(await i.p.from("billing_subscriptions").upsert({org_id:t,stripe_subscription_id:e.id,tier:e.items?.data?.[0]?.price?.nickname??"premium",status:e.status,current_period_end:new Date(1e3*e.current_period_end).toISOString()}),["active","trialing"].includes(e.status)||await i.p.from("profiles").update({app_is_premium:!1}).eq("org_id",t))}t.status(200).end()}catch(e){t.status(500).json({error:"webhook_fail",detail:String(e)})}}r()}catch(e){r(e)}})},43690:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.d(t,{A:()=>n});var a=s(36090),i=e([a]);let n=new(a=(i.then?(await i)():i)[0]).default(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-06-20"});r()}catch(e){r(e)}})},85611:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.d(t,{p:()=>n});var a=s(4864),i=e([a]);a=(i.then?(await i)():i)[0];let n=(0,a.createClient)(process.env.SUPABASE_URL||"https://dummy.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.SUPABASE_SERVICE_ROLE||process.env.SUPABASE_SERVICE_KEY,{auth:{persistSession:!1}});r()}catch(e){r(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[6791],()=>s(28656));module.exports=r})();