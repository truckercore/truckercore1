"use strict";(()=>{var e={};e.id=8791,e.ids=[8791],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},10146:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>$,patchFetch:()=>m,requestAsyncStorage:()=>_,routeModule:()=>h,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g});var a={};r.r(a),r.d(a,{GET:()=>l});var o=r(49303),s=r(88716),n=r(60670),i=r(84770),p=r.n(i);let c="https://dummy.supabase.co",u=process.env.SUPABASE_SERVICE_ROLE_KEY,d=process.env.EXPORTS_BUCKET||"exports";async function l(e){try{let t;if(!u)return new Response("Service key missing",{status:500});let r=e.headers.get("x-app-org-id")||new URL(e.url).searchParams.get("org_id")||void 0;if(!r)return new Response("org_id required",{status:400});let a=new URL(e.url).searchParams.get("quarter_start")||function(e=new Date){let t=e.getUTCMonth();return new Date(Date.UTC(e.getUTCFullYear(),3*Math.floor(t/3),1)).toISOString().slice(0,10)}(),o=Number(process.env.EXPORT_ROI_MONTHLY_CAP||10);{let e=new Date,t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),1)).toISOString().slice(0,10),a=new URL(`${c.replace(/\/$/,"")}/rest/v1/export_usage`);a.searchParams.set("org_id",`eq.${r}`),a.searchParams.set("period_month",`eq.${t}`),a.searchParams.set("kind","eq.roi_pdf"),a.searchParams.set("select","count");let s=await fetch(a,{headers:{apikey:u,Authorization:`Bearer ${u}`},cache:"no-store"}),n=await s.json().catch(()=>[]),i=n?.[0]?.count??0;if(i>=o){let e=new Headers;return e.set("X-Export-Used",String(i)),e.set("X-Export-Cap",String(o)),new Response("Monthly ROI report limit reached",{status:402,headers:e})}}{let e=`${c.replace(/\/$/,"")}/rest/v1/rpc/generate_roi_report`,o=await fetch(e,{method:"POST",headers:{apikey:u,Authorization:`Bearer ${u}`,"Content-Type":"application/json",Prefer:"params=single-object"},body:JSON.stringify({p_org:r,p_quarter_start:a})});if(!o.ok)return new Response("Failed to generate report",{status:500});t=(await o.text()).replace(/"/g,"")}let s=new URL(`${c.replace(/\/$/,"")}/rest/v1/safety_roi_reports`);s.searchParams.set("id",`eq.${t}`),s.searchParams.set("select","*");let n=await fetch(s,{headers:{apikey:u,Authorization:`Bearer ${u}`},cache:"no-store"}),i=await n.json();if(!Array.isArray(i)||!i[0])return new Response("Report not found",{status:404});let l=i[0],h=`
Quarterly Safety ROI Report
Org: ${r}
Quarter: ${l.quarter_start} â€“ ${l.quarter_end}

Baseline (previous Q): ${l.baseline_total_alerts} alerts, ${l.baseline_urgent_alerts} urgent
This Quarter: ${l.period_total_alerts} alerts, ${l.period_urgent_alerts} urgent
Change: ${l.delta_pct??"N/A"}%

Top 5 Risk Corridors:
${JSON.stringify(l.top_corridors,null,2)}

Insurance Note:
${l.insurance_note||""}
`,_=Buffer.from(h),g=p().createHash("sha256").update(_).digest("hex"),f=`roi_${r}_${a}.pdf`,$=`${r}/${new Date().toISOString().slice(0,10)}/${f}`;{let e=`${c.replace(/\/$/,"")}/storage/v1/object/${encodeURIComponent(d)}/${encodeURIComponent($)}`;await fetch(e,{method:"POST",headers:{apikey:u,Authorization:`Bearer ${u}`,"Content-Type":"application/pdf","x-upsert":"true"},body:_}).catch(()=>{})}{let e=`${c.replace(/\/$/,"")}/rest/v1/export_artifacts`;await fetch(e,{method:"POST",headers:{apikey:u,Authorization:`Bearer ${u}`,"Content-Type":"application/json",Prefer:"resolution=merge-duplicates"},body:JSON.stringify({org_id:r,kind:"roi_pdf",from_ts:l.quarter_start,to_ts:l.quarter_end,filename:f,content_type:"application/pdf",bytes:_.length,storage_path:`${d}/${$}`,sha256:g,signed:!0})}).catch(()=>{})}{let e=`${c.replace(/\/$/,"")}/rest/v1/rpc/increment_export_usage`;await fetch(e,{method:"POST",headers:{apikey:u,Authorization:`Bearer ${u}`,"Content-Type":"application/json",Prefer:"params=single-object"},body:JSON.stringify({p_org:r,p_kind:"roi_pdf"})}).catch(()=>{})}let m=new Headers;return m.set("Content-Type","application/pdf"),m.set("Content-Disposition",`attachment; filename="${f}"`),m.set("X-Artifact-SHA256",g),m.set("Cache-Control","no-store"),new Response(_,{status:200,headers:m})}catch(e){return console.error(e),new Response("Server error",{status:500})}}let h=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/export-roi-report.pdf/route",pathname:"/api/export-roi-report.pdf",filename:"route",bundlePath:"app/api/export-roi-report.pdf/route"},resolvedPagePath:"C:\\Users\\moise\\IdeaProjects\\truckercore1\\apps\\web\\src\\app\\api\\export-roi-report.pdf\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:_,staticGenerationAsyncStorage:g,serverHooks:f}=h,$="/api/export-roi-report.pdf/route";function m(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},49303:(e,t,r)=>{e.exports=r(30517)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948],()=>r(10146));module.exports=a})();